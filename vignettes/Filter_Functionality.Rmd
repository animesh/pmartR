---
title: "Filter Functions"
author: "Kelly Stratton, Lisa Bramer"
date: "`r Sys.Date()`"
output: 
  html_document:
    df_print: paged
    rmarkdown::html_vignette:
    fig_caption: yes
    self_contained: yes
    toc: true
bibliography: bibliography.bib
vignette: >
  %\VignetteIndexEntry{pmartR-filters} 
  %\VignetteEngine{knitr::rmarkdown} 
  %\VignetteEncoding{UTF-8}
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning=FALSE, fig.width = 8, fig.height = 6, echo = TRUE, include = TRUE, eval = TRUE)
options(rmarkdown.html_vignette.check_title = FALSE)
```

```{r logo, out.width = "100px", echo=FALSE}
knitr::include_graphics("pmartR_logo_final.jpg")

library(pmartR)
library(pmartRdata)
library(ggplot2)
library(reshape2)
```

**Need to decide how to handle seqData filters--are those included here, or is this focusing on the other omicsData objects?**


## Overview

This vignette describes the filter functionality of the `pmartR` package. Filters fall into two categories and their use is a standard part of quality control processing.

1. Biomolecule filters

2. Sample filters

In a typical `pmartR` processing pipeline, these filters are applied in a certain order during the quality control process.

To utilize a filter, the first step is to create the filter object, an S3 object whose class is directly tied to the filter. Once a filter object is created, the `plot()` and `summary()` functions can be used to see the effects of applying the filter with certain parameters, and then the filter can be applied to the omicsData object using the `applyFilt()` function.


## Biomolecule Filters

The following filters remove entire biomolecules from omicsData objects. 

### Molecule Filter

The motivation for using the molecule filter is to remove any biomolecules not confidently observed. Typical use of the molecule filter removes any biomolecules that are not observed in at least two samples across the entire dataset, within each group, or within each batch. Depending on downstream analysis goals, a different threshold may be more appropriate.

Below we demonstrate creation and application of the molecule filter on a pepData object.

```{r molecule filter}

```

To implement a molecule filter with the minimum required number of observations is within each group, we must first define groups.

```{r molecule filter groups}

```

If our samples were run on the instrument over the course of multiple batches, we may wish to implement the molecule filter within each batch.

```{r molecule filter batches}

```


### Coefficient of Variation (CV) Filter

The coefficient of variation (CV) is the ratio of the standard deviation to the mean [@ahmed1995pooling]. We can use the CV calculated for each biomolecule as a quality control filter to remove highly variable biomolecules. Using the pooled CV, as `pmartR` does, enables the experimental groups to be accounted for. Note that the CV is calculated on the abundance scale (if already log transformed, the `cv_filter()` function accounts for this).

```{r cv filter}

```


### Proteomics Filter

For proteomics data (pepData object where mapping of peptides-to-proteins is included in e_meta), two additional filters are availble via the `proteomics_filter()` function.

#### Redundant Peptide Filter

In some instances, peptides can map to more than one protein; peptides such as this are called "redundant" or "degenerate". Redundant peptides can be removed using the `proteomics_filter()`.

```{r}

```


#### Minimum Number of Peptides per Protein Filter

Sometimes it is of interest to remove any proteins that are not "confidently" observed, where "confidently" is defined by the number of peptides observed that map to a given protein. For instance, we could use the following filter to remove any proteins (and their associated peptides) that have fewer than 2 peptides mapping to them.

```{r}

```

### IMD-ANOVA Filter

If ANOVA and/or the IMD test will be used for downstream statistical comparisons, any biomolecules for which the desired test cannot be run can be removed using the following filter.

In the case where both ANOVA and IMD will be performed:

```{r combined test}

```

If only ANOVA is of interest:

```{r anova only}

```

If only the IMD test is of interest:

```{r gtest only}

```


### Custom Filter

If certain biomolecules are known *a priori* to be unwanted in the analysis, those can be removed using a custom filter. For instance if contaminant proteins are identified, or a set of internal standards needs to be removed for a specific portion of the analysis, this filter can be of particular use. Multiple custom filters could be applied to a single dataset, depending on the analysis needs. Biomolecules for removal can be specified based on their presence in e_data or in e_meta.

To remove biomolecules based on their presence in e_data, we implement the filter as follows. Note that this also removes them from e_meta, if applicable.

```{r remove from e_data}

```

To remove biomolecules based on their presence in e_meta (such as specifying proteins to remove from a pepData object), we implement the filter as follows. This also removes the associated biomolecules from e_data, as applicable.

```{r remove from e_meta}

```


## Sample Filters

The following filters remove entire samples from omicsData objects. 

### rMd-PAV Filter

The robust Mahalanobis distance squared values associated with the peptide abundances vector (rMd-PAV) is a method which computes a rMd and that can be mapped to a p-value and used to identify outlying samples [@matzke2011improved]. Any identified samples can be reviewed by the analyst to determine whether to remove them from the dataset.

The metrics on which the log2 robust Mahalanobis distance is based can be specified using the `metrics` argument of the `rmd_filter()` function. Available metrics include:

- Median absolute deviation (MAD)

- Correlation

- Skewness

- Kurtosis

- Proportion Missing

For pepData and proData objects, the default is to use all five of the metrics. For metabData and lipidData objects, the default is to exclude the proportion missing (as these data typically do not have much missing data).


```{r create rmd and plot}

```


```{r rmd plot individ outliers}

```



### Custom Filter

A custom filter can be used to remove entire samples. This is particularly useful if only a subset of potential outliers identified by the rMd filter are to be removed, or if quality control samples that were run within the experiment are no longer needed for a particular analysis step.

```{r}

```


## Typical Order of Filter Application

A custom filter could be applied at any point, depending on the study and dataset. For instance, if proteomics data and there are contaminant proteins or reverse hits, a custom filter can be used first thing to remove these. If the RMD filter identifies potential outliers but not all are to be removed, a custom filter can be used to remove a subset of samples.

1. Molecule filter

2. CV filter (if using--we often do not)

3. Proteomics filter (if proteomics data)

4. RMD filter

5. IMD-ANOVA filter


## References


